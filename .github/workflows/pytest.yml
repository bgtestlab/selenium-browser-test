name: pytest workflow

on:
  workflow_dispatch:

jobs:
  pytest:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v2
      
    - name: Run pytest
      run: |
        docker-compose -f ./docker/docker-compose.yaml config
        docker-compose -f ./docker/docker-compose.yaml up \
        --abort-on-container-exit \
        --exit-code-from test-runner
        
    - name: Extract test results
      run: |
        docker cp test-runner:/app/output .
        
    - name: Send test results to Slack
      id: slack
      uses: slackapi/slack-github-action@v1.19.0
      with:
        channel-id: test
        payload-file-path: "./output/*.json"
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }} 
        SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
      if: always()
